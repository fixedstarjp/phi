/*! For license information please see popup.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,s,a,i,o=[],c=!0,u=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(o.push(r.value),o.length!==e);c=!0);}catch(t){u=!0,s=t}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw s}}return o}}(t,e)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function r(){var t,e,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function o(n,r,a,i){var o=r&&r.prototype instanceof u?r:u,l=Object.create(o.prototype);return s(l,"_invoke",function(n,r,s){var a,i,o,u=0,l=s||[],h=!1,d={p:0,n:0,v:t,a:y,f:y.bind(t,4),d:function(e,n){return a=e,i=0,o=t,d.n=n,c}};function y(n,r){for(i=n,o=r,e=0;!h&&u&&!s&&e<l.length;e++){var s,a=l[e],y=d.p,f=a[2];n>3?(s=f===r)&&(o=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=t):a[0]<=y&&((s=n<2&&y<a[1])?(i=0,d.v=r,d.n=a[1]):y<f&&(s=n<3||a[0]>r||r>f)&&(a[4]=n,a[5]=r,d.n=f,i=0))}if(s||n>1)return c;throw h=!0,r}return function(s,l,f){if(u>1)throw TypeError("Generator is already running");for(h&&1===l&&y(l,f),i=l,o=f;(e=i<2?t:o)||!h;){a||(i?i<3?(i>1&&(d.n=-1),y(i,o)):d.n=o:d.v=o);try{if(u=2,a){if(i||(s="next"),e=a[s]){if(!(e=e.call(a,o)))throw TypeError("iterator result is not an object");if(!e.done)return e;o=e.value,i<2&&(i=0)}else 1===i&&(e=a.return)&&e.call(a),i<2&&(o=TypeError("The iterator does not provide a '"+s+"' method"),i=1);a=t}else if((e=(h=d.n<0)?o:n.call(r,d))!==c)break}catch(e){a=t,i=1,o=e}finally{u=1}}return{value:e,done:h}}}(n,a,i),!0),l}var c={};function u(){}function l(){}function h(){}e=Object.getPrototypeOf;var d=[][a]?e(e([][a]())):(s(e={},a,function(){return this}),e),y=h.prototype=u.prototype=Object.create(d);function f(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,h):(t.__proto__=h,s(t,i,"GeneratorFunction")),t.prototype=Object.create(y),t}return l.prototype=h,s(y,"constructor",h),s(h,"constructor",l),l.displayName="GeneratorFunction",s(h,i,"GeneratorFunction"),s(y),s(y,i,"Generator"),s(y,a,function(){return this}),s(y,"toString",function(){return"[object Generator]"}),(r=function(){return{w:o,m:f}})()}function s(t,e,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}s=function(t,e,n,r){if(e)a?a(t,e,{value:n,enumerable:!r,configurable:!r,writable:!r}):t[e]=n;else{var i=function(e,n){s(t,e,function(t){return this._invoke(e,n,t)})};i("next",0),i("throw",1),i("return",2)}},s(t,e,n,r)}function a(t,e,n,r,s,a,i){try{var o=t[a](i),c=o.value}catch(t){return void n(t)}o.done?e(c):Promise.resolve(c).then(r,s)}function i(t){return function(){var e=this,n=arguments;return new Promise(function(r,s){var i=t.apply(e,n);function o(t){a(i,r,s,o,c,"next",t)}function c(t){a(i,r,s,o,c,"throw",t)}o(void 0)})}}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,c(r.key),r)}}function c(e){var n=function(e){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(n)?n:n+""}var u=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.chatHistory=[],this.isModelReady=!1,this.initializeElements(),this.setupEventListeners(),this.loadChatHistory(),this.checkModelStatus()},n=[{key:"initializeElements",value:function(){this.modelStatusEl=document.getElementById("modelStatus"),this.summarizeBtn=document.getElementById("summarizeBtn"),this.translateBtn=document.getElementById("translateBtn"),this.chatHistoryEl=document.getElementById("chatHistory"),this.messageInput=document.getElementById("messageInput"),this.sendBtn=document.getElementById("sendBtn"),this.clearBtn=document.getElementById("clearBtn")}},{key:"setupEventListeners",value:function(){var t=this;this.summarizeBtn.addEventListener("click",function(){return t.summarizePage()}),this.translateBtn.addEventListener("click",function(){return t.translateSelection()}),this.sendBtn.addEventListener("click",function(){return t.sendMessage()}),this.clearBtn.addEventListener("click",function(){return t.clearHistory()}),this.messageInput.addEventListener("keypress",function(e){"Enter"===e.key&&t.sendMessage()}),chrome.runtime.onMessage.addListener(function(e){"MODEL_READY"===e.type?t.onModelReady():"MODEL_ERROR"===e.type&&t.onModelError(e.error)})}},{key:"checkModelStatus",value:(u=i(r().m(function t(){var e,n;return r().w(function(t){for(;;)switch(t.n){case 0:return t.p=0,t.n=1,chrome.runtime.sendMessage({type:"GET_MODEL_STATUS"});case 1:if(!(e=t.v).isLoading){t.n=2;break}this.updateStatus("loading","モデル読み込み中..."),t.n=4;break;case 2:if(!e.isReady){t.n=3;break}this.onModelReady(),t.n=4;break;case 3:return this.updateStatus("loading","モデルを初期化中..."),t.n=4,chrome.runtime.sendMessage({type:"LOAD_MODEL"});case 4:t.n=6;break;case 5:t.p=5,n=t.v,this.onModelError(n.message);case 6:return t.a(2)}},t,this,[[0,5]])})),function(){return u.apply(this,arguments)})},{key:"onModelReady",value:function(){this.isModelReady=!0,this.updateStatus("ready","✅ モデル準備完了"),this.enableUI()}},{key:"onModelError",value:function(t){this.isModelReady=!1,this.updateStatus("error","❌ エラー: ".concat(t)),this.disableUI()}},{key:"updateStatus",value:function(t,e){this.modelStatusEl.textContent=e,this.modelStatusEl.className="status-".concat(t)}},{key:"enableUI",value:function(){this.summarizeBtn.disabled=!1,this.translateBtn.disabled=!1,this.messageInput.disabled=!1,this.sendBtn.disabled=!1}},{key:"disableUI",value:function(){this.summarizeBtn.disabled=!0,this.translateBtn.disabled=!0,this.messageInput.disabled=!0,this.sendBtn.disabled=!0}},{key:"summarizePage",value:(c=i(r().m(function t(){var n,s,a,i,o,c;return r().w(function(t){for(;;)switch(t.n){case 0:return t.p=0,t.n=1,chrome.tabs.query({active:!0,currentWindow:!0});case 1:return n=t.v,s=e(n,1),a=s[0],t.n=2,chrome.tabs.sendMessage(a.id,{type:"GET_PAGE_CONTENT"});case 2:if(!(i=t.v).success){t.n=4;break}return this.addMessage("user","ページの要約をお願いします"),this.addMessage("ai","ページを要約中...",!0),t.n=3,chrome.runtime.sendMessage({type:"SUMMARIZE_TEXT",text:i.content});case 3:o=t.v,this.updateLastMessage(o.success?o.response:"エラー: ".concat(o.error));case 4:t.n=6;break;case 5:t.p=5,c=t.v,this.addMessage("ai","エラーが発生しました: ".concat(c.message));case 6:return t.a(2)}},t,this,[[0,5]])})),function(){return c.apply(this,arguments)})},{key:"translateSelection",value:(a=i(r().m(function t(){var n,s,a,i,o,c;return r().w(function(t){for(;;)switch(t.n){case 0:return t.p=0,t.n=1,chrome.tabs.query({active:!0,currentWindow:!0});case 1:return n=t.v,s=e(n,1),a=s[0],t.n=2,chrome.tabs.sendMessage(a.id,{type:"GET_SELECTION"});case 2:if(!(i=t.v).success||!i.text){t.n=4;break}return this.addMessage("user","「".concat(i.text,"」を日本語に翻訳してください")),this.addMessage("ai","翻訳中...",!0),t.n=3,chrome.runtime.sendMessage({type:"TRANSLATE_TEXT",text:i.text});case 3:o=t.v,this.updateLastMessage(o.success?o.response:"エラー: ".concat(o.error)),t.n=5;break;case 4:this.addMessage("ai","テキストが選択されていません");case 5:t.n=7;break;case 6:t.p=6,c=t.v,this.addMessage("ai","エラーが発生しました: ".concat(c.message));case 7:return t.a(2)}},t,this,[[0,6]])})),function(){return a.apply(this,arguments)})},{key:"sendMessage",value:(s=i(r().m(function t(){var e,n,s;return r().w(function(t){for(;;)switch(t.n){case 0:if(e=this.messageInput.value.trim()){t.n=1;break}return t.a(2);case 1:return this.messageInput.value="",this.addMessage("user",e),this.addMessage("ai","考え中...",!0),t.p=2,t.n=3,chrome.runtime.sendMessage({type:"GENERATE_TEXT",prompt:"Human: ".concat(e,"\nAssistant:"),maxTokens:512});case 3:n=t.v,this.updateLastMessage(n.success?n.response:"エラー: ".concat(n.error)),t.n=5;break;case 4:t.p=4,s=t.v,this.updateLastMessage("エラーが発生しました: ".concat(s.message));case 5:return t.a(2)}},t,this,[[2,4]])})),function(){return s.apply(this,arguments)})},{key:"addMessage",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=document.createElement("div");r.className="message ".concat(t,"-message"),n?r.innerHTML="".concat(e,' <span class="loading"></span>'):r.textContent=e,this.chatHistoryEl.appendChild(r),this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight,this.chatHistory.push({sender:t,content:e,timestamp:Date.now()}),this.saveChatHistory()}},{key:"updateLastMessage",value:function(t){var e=this.chatHistoryEl.lastElementChild;e&&(e.textContent=t,this.chatHistory.length>0&&(this.chatHistory[this.chatHistory.length-1].content=t,this.saveChatHistory()))}},{key:"clearHistory",value:function(){this.chatHistory=[],this.chatHistoryEl.innerHTML="",this.saveChatHistory()}},{key:"saveChatHistory",value:function(){chrome.storage.local.set({chatHistory:this.chatHistory})}},{key:"loadChatHistory",value:function(){var t=this;chrome.storage.local.get("chatHistory",function(e){e.chatHistory&&(t.chatHistory=e.chatHistory,t.renderChatHistory())})}},{key:"renderChatHistory",value:function(){var t=this;this.chatHistoryEl.innerHTML="",this.chatHistory.forEach(function(e){var n=document.createElement("div");n.className="message ".concat(e.sender,"-message"),n.textContent=e.content,t.chatHistoryEl.appendChild(n)}),this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight}}],n&&o(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,s,a,c,u}();document.addEventListener("DOMContentLoaded",function(){new u})})();