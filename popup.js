/*! For license information please see popup.js.LICENSE.txt */
(()=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,s,a,i,o=[],c=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(o.push(r.value),o.length!==t);c=!0);}catch(e){u=!0,s=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw s}}return o}}(e,t)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function r(){var e,t,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",i=n.toStringTag||"@@toStringTag";function o(n,r,a,i){var o=r&&r.prototype instanceof u?r:u,l=Object.create(o.prototype);return s(l,"_invoke",function(n,r,s){var a,i,o,u=0,l=s||[],d=!1,h={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,n){return a=t,i=0,o=e,h.n=n,c}};function p(n,r){for(i=n,o=r,t=0;!d&&u&&!s&&t<l.length;t++){var s,a=l[t],p=h.p,y=a[2];n>3?(s=y===r)&&(o=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=p&&((s=n<2&&p<a[1])?(i=0,h.v=r,h.n=a[1]):p<y&&(s=n<3||a[0]>r||r>y)&&(a[4]=n,a[5]=r,h.n=y,i=0))}if(s||n>1)return c;throw d=!0,r}return function(s,l,y){if(u>1)throw TypeError("Generator is already running");for(d&&1===l&&p(l,y),i=l,o=y;(t=i<2?e:o)||!d;){a||(i?i<3?(i>1&&(h.n=-1),p(i,o)):h.n=o:h.v=o);try{if(u=2,a){if(i||(s="next"),t=a[s]){if(!(t=t.call(a,o)))throw TypeError("iterator result is not an object");if(!t.done)return t;o=t.value,i<2&&(i=0)}else 1===i&&(t=a.return)&&t.call(a),i<2&&(o=TypeError("The iterator does not provide a '"+s+"' method"),i=1);a=e}else if((t=(d=h.n<0)?o:n.call(r,h))!==c)break}catch(t){a=e,i=1,o=t}finally{u=1}}return{value:t,done:d}}}(n,a,i),!0),l}var c={};function u(){}function l(){}function d(){}t=Object.getPrototypeOf;var h=[][a]?t(t([][a]())):(s(t={},a,function(){return this}),t),p=d.prototype=u.prototype=Object.create(h);function y(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,s(e,i,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=d,s(p,"constructor",d),s(d,"constructor",l),l.displayName="GeneratorFunction",s(d,i,"GeneratorFunction"),s(p),s(p,i,"Generator"),s(p,a,function(){return this}),s(p,"toString",function(){return"[object Generator]"}),(r=function(){return{w:o,m:y}})()}function s(e,t,n,r){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}s=function(e,t,n,r){if(t)a?a(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n;else{var i=function(t,n){s(e,t,function(e){return this._invoke(t,n,e)})};i("next",0),i("throw",1),i("return",2)}},s(e,t,n,r)}function a(e,t,n,r,s,a,i){try{var o=e[a](i),c=o.value}catch(e){return void n(e)}o.done?t(c):Promise.resolve(c).then(r,s)}function i(e){return function(){var t=this,n=arguments;return new Promise(function(r,s){var i=e.apply(t,n);function o(e){a(i,r,s,o,c,"next",e)}function c(e){a(i,r,s,o,c,"throw",e)}o(void 0)})}}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,c(r.key),r)}}function c(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,"string");if("object"!=e(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}var u=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.chatHistory=[],this.isModelReady=!1,this.modelName="StableLM-2-Zephyr-1.6B",this.downloadProgress=0,this.initializeElements(),this.setupEventListeners(),this.loadChatHistory(),this.checkModelStatus()},n=[{key:"initializeElements",value:function(){this.modelStatusEl=document.getElementById("modelStatus"),this.summarizeBtn=document.getElementById("summarizeBtn"),this.translateBtn=document.getElementById("translateBtn"),this.chatHistoryEl=document.getElementById("chatHistory"),this.messageInput=document.getElementById("messageInput"),this.sendBtn=document.getElementById("sendBtn"),this.clearBtn=document.getElementById("clearBtn"),this.createProgressBar()}},{key:"createProgressBar",value:function(){var e=document.createElement("div");e.id="progressContainer",e.style.cssText="\n      display: none;\n      margin: 10px 0;\n      background: rgba(255,255,255,0.1);\n      border-radius: 8px;\n      padding: 8px;\n    ";var t=document.createElement("div");t.id="progressLabel",t.style.cssText="\n      color: white;\n      font-size: 12px;\n      margin-bottom: 5px;\n      text-align: center;\n    ",t.textContent="モデルダウンロード中...";var n=document.createElement("div");n.style.cssText="\n      background: rgba(255,255,255,0.2);\n      border-radius: 4px;\n      height: 6px;\n      overflow: hidden;\n    ";var r=document.createElement("div");r.id="progressBar",r.style.cssText="\n      background: linear-gradient(90deg, #4CAF50, #8BC34A);\n      height: 100%;\n      width: 0%;\n      border-radius: 4px;\n      transition: width 0.3s ease;\n      box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);\n    ";var s=document.createElement("div");s.id="progressText",s.style.cssText="\n      color: white;\n      font-size: 11px;\n      text-align: center;\n      margin-top: 5px;\n    ",s.textContent="0%",n.appendChild(r),e.appendChild(t),e.appendChild(n),e.appendChild(s),document.querySelector(".header").appendChild(e),this.progressContainer=e,this.progressBar=r,this.progressText=s,this.progressLabel=t}},{key:"setupEventListeners",value:function(){var e=this;this.summarizeBtn.addEventListener("click",function(){return e.summarizePage()}),this.translateBtn.addEventListener("click",function(){return e.translateSelection()}),this.sendBtn.addEventListener("click",function(){return e.sendMessage()}),this.clearBtn.addEventListener("click",function(){return e.clearHistory()}),this.messageInput.addEventListener("keypress",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),e.sendMessage())}),chrome.runtime.onMessage.addListener(function(t){"MODEL_LOADING"===t.type?e.onModelLoading():"MODEL_READY"===t.type?e.onModelReady(t.modelName):"MODEL_ERROR"===t.type?e.onModelError(t.error):"DOWNLOAD_PROGRESS"===t.type&&e.updateDownloadProgress(t.progress)})}},{key:"checkModelStatus",value:(u=i(r().m(function e(){var t,n;return r().w(function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,chrome.runtime.sendMessage({type:"GET_MODEL_STATUS"});case 1:if(!(t=e.v).isLoading){e.n=2;break}this.onModelLoading(),t.progress&&this.updateDownloadProgress(t.progress),e.n=4;break;case 2:if(!t.isReady){e.n=3;break}this.onModelReady(t.modelName),e.n=4;break;case 3:return this.updateStatus("loading","🔄 モデルを初期化中..."),e.n=4,chrome.runtime.sendMessage({type:"LOAD_MODEL"});case 4:e.n=6;break;case 5:e.p=5,n=e.v,this.onModelError(n.message);case 6:return e.a(2)}},e,this,[[0,5]])})),function(){return u.apply(this,arguments)})},{key:"onModelLoading",value:function(){this.isModelReady=!1,this.updateStatus("loading","⏳ StableLM-2-Zephyr-1.6B ダウンロード中..."),this.showProgressBar(),this.disableUI()}},{key:"onModelReady",value:function(e){this.isModelReady=!0,this.modelName=e||"StableLM-2-Zephyr-1.6B",this.updateStatus("ready","✅ ".concat(this.modelName," 準備完了")),this.hideProgressBar(),this.enableUI(),0===this.chatHistory.length&&this.addMessage("ai","こんにちは！".concat(this.modelName,"モデルの準備が完了しました。\n\n以下の機能が利用できます：\n• 📄 ページ要約\n• 🈯 選択テキスト翻訳\n• 💬 自由な質問や会話\n\n何かお手伝いできることはありますか？"))}},{key:"onModelError",value:function(e){this.isModelReady=!1,this.updateStatus("error","❌ エラー: ".concat(e)),this.hideProgressBar(),this.disableUI(),this.addMessage("ai","申し訳ございません。モデルの読み込みでエラーが発生しました：\n".concat(e,"\n\n拡張機能を再起動してお試しください。"))}},{key:"updateDownloadProgress",value:function(e){this.downloadProgress=e,this.progressBar&&this.progressText&&(this.progressBar.style.width="".concat(e,"%"),this.progressText.textContent="".concat(e,"% (約800MB)"),e<10?this.progressLabel.textContent="モデルダウンロード開始中...":e<50?this.progressLabel.textContent="モデルダウンロード中...":e<90?this.progressLabel.textContent="ダウンロード完了間近...":e<100&&(this.progressLabel.textContent="モデル初期化中..."))}},{key:"showProgressBar",value:function(){this.progressContainer&&(this.progressContainer.style.display="block")}},{key:"hideProgressBar",value:function(){this.progressContainer&&(this.progressContainer.style.display="none")}},{key:"updateStatus",value:function(e,t){this.modelStatusEl.textContent=t,this.modelStatusEl.className="status-".concat(e)}},{key:"enableUI",value:function(){this.summarizeBtn.disabled=!1,this.translateBtn.disabled=!1,this.messageInput.disabled=!1,this.sendBtn.disabled=!1,this.messageInput.placeholder="メッセージを入力..."}},{key:"disableUI",value:function(){this.summarizeBtn.disabled=!0,this.translateBtn.disabled=!0,this.messageInput.disabled=!0,this.sendBtn.disabled=!0,this.messageInput.placeholder="モデル読み込み中..."}},{key:"summarizePage",value:(c=i(r().m(function e(){var n,s,a,i,o,c;return r().w(function(e){for(;;)switch(e.n){case 0:if(this.isModelReady){e.n=1;break}return this.addMessage("ai","モデルの準備ができていません。しばらくお待ちください。"),e.a(2);case 1:return e.p=1,e.n=2,chrome.tabs.query({active:!0,currentWindow:!0});case 2:return n=e.v,s=t(n,1),a=s[0],this.addMessage("user","📄 このページを要約してください"),this.addMessage("ai","📄 ページ内容を取得して要約中...",!0),e.n=3,chrome.tabs.sendMessage(a.id,{type:"GET_PAGE_CONTENT"});case 3:if(!(i=e.v).success){e.n=5;break}return e.n=4,chrome.runtime.sendMessage({type:"SUMMARIZE_TEXT",text:i.content});case 4:o=e.v,this.updateLastMessage(o.success?"**ページ要約:**\n\n".concat(o.response):"エラーが発生しました: ".concat(o.error)),e.n=6;break;case 5:this.updateLastMessage("ページ内容の取得に失敗しました。");case 6:e.n=8;break;case 7:e.p=7,c=e.v,this.updateLastMessage("エラーが発生しました: ".concat(c.message));case 8:return e.a(2)}},e,this,[[1,7]])})),function(){return c.apply(this,arguments)})},{key:"translateSelection",value:(a=i(r().m(function e(){var n,s,a,i,o,c;return r().w(function(e){for(;;)switch(e.n){case 0:if(this.isModelReady){e.n=1;break}return this.addMessage("ai","モデルの準備ができていません。しばらくお待ちください。"),e.a(2);case 1:return e.p=1,e.n=2,chrome.tabs.query({active:!0,currentWindow:!0});case 2:return n=e.v,s=t(n,1),a=s[0],e.n=3,chrome.tabs.sendMessage(a.id,{type:"GET_SELECTION"});case 3:if(!(i=e.v).success||!i.text){e.n=5;break}return this.addMessage("user","🈯 「".concat(i.text,"」を日本語に翻訳してください")),this.addMessage("ai","🈯 翻訳中...",!0),e.n=4,chrome.runtime.sendMessage({type:"TRANSLATE_TEXT",text:i.text});case 4:o=e.v,this.updateLastMessage(o.success?"**翻訳結果:**\n\n".concat(o.response):"エラーが発生しました: ".concat(o.error)),e.n=6;break;case 5:this.addMessage("ai","翻訳するテキストを選択してください。");case 6:e.n=8;break;case 7:e.p=7,c=e.v,this.addMessage("ai","エラーが発生しました: ".concat(c.message));case 8:return e.a(2)}},e,this,[[1,7]])})),function(){return a.apply(this,arguments)})},{key:"sendMessage",value:(s=i(r().m(function e(){var t,n,s;return r().w(function(e){for(;;)switch(e.n){case 0:if(t=this.messageInput.value.trim()){e.n=1;break}return e.a(2);case 1:if(this.isModelReady){e.n=2;break}return this.addMessage("ai","モデルの準備ができていません。しばらくお待ちください。"),e.a(2);case 2:return this.messageInput.value="",this.addMessage("user",t),this.addMessage("ai","🤔 考え中...",!0),e.p=3,e.n=4,chrome.runtime.sendMessage({type:"GENERATE_TEXT",prompt:t,maxTokens:512});case 4:n=e.v,this.updateLastMessage(n.success?n.response:"エラーが発生しました: ".concat(n.error)),e.n=6;break;case 5:e.p=5,s=e.v,this.updateLastMessage("エラーが発生しました: ".concat(s.message));case 6:return e.a(2)}},e,this,[[3,5]])})),function(){return s.apply(this,arguments)})},{key:"addMessage",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=document.createElement("div");if(r.className="message ".concat(e,"-message"),n)r.innerHTML="".concat(t,' <span class="loading"></span>');else{var s=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>");r.innerHTML=s}this.chatHistoryEl.appendChild(r),this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight,n||(this.chatHistory.push({sender:e,content:t,timestamp:Date.now()}),this.saveChatHistory())}},{key:"updateLastMessage",value:function(e){var t=this.chatHistoryEl.lastElementChild;if(t){var n=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>");t.innerHTML=n,this.chatHistory.length>0?this.chatHistory[this.chatHistory.length-1].content=e:this.chatHistory.push({sender:"ai",content:e,timestamp:Date.now()}),this.saveChatHistory()}}},{key:"clearHistory",value:function(){confirm("会話履歴を削除しますか？")&&(this.chatHistory=[],this.chatHistoryEl.innerHTML="",this.saveChatHistory(),this.addMessage("ai","会話履歴をクリアしました。新しい会話を開始できます！"))}},{key:"saveChatHistory",value:function(){chrome.storage.local.set({chatHistory:this.chatHistory})}},{key:"loadChatHistory",value:function(){var e=this;chrome.storage.local.get("chatHistory",function(t){t.chatHistory&&(e.chatHistory=t.chatHistory,e.renderChatHistory())})}},{key:"renderChatHistory",value:function(){var e=this;this.chatHistoryEl.innerHTML="",this.chatHistory.forEach(function(t){var n=document.createElement("div");n.className="message ".concat(t.sender,"-message");var r=t.content.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>");n.innerHTML=r,e.chatHistoryEl.appendChild(n)}),this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight}}],n&&o(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,s,a,c,u}();document.addEventListener("DOMContentLoaded",function(){new u})})();